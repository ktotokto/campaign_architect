{% extends "base.html" %}


{% block styles %}
{{ super() }}
<style>
    .graph-container {
        width: 100%;
        height: 80vh;
        background-color: #1a120b;
        border-radius: 8px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="tab-content active">
    <h2>üï∏Ô∏è –ì—Ä–∞—Ñ —Å–æ–±—ã—Ç–∏–π –∫–∞–º–ø–∞–Ω–∏–∏ "{{ campaign.title }}"</h2>

    <div id="network" class="graph-container"></div>

    <button class="btn save-btn" onclick="saveGraph()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤—è–∑–∏</button>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vis-data@7.1.3"></script>
<script src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
<script>
    const nodes = new vis.DataSet([
        {% for node in nodes %}
        { id: {{ node.id }}, label: "{{ node.name }}", group: "{{ node.type }}" },
        {% endfor %}
    ]);

    const edges = new vis.DataSet([
        {% for edge in edges %}
        { from: {{ edge.from }}, to: {{ edge.to }}, label: "{{ edge.label }}" },
        {% endfor %}
    ]);

    const container = document.getElementById("network");
    const data = {
        nodes: nodes,
        edges: edges
    };

    const options = {
        nodes: {
            shape: 'dot',
            size: 20,
            font: {
                color: '#f5d742'
            },
            color: {
                border: '#c9a227',
                background: '#3a250f',
                highlight: {
                    border: '#f5d742',
                    background: '#5e2c04'
                }
            }
        },
        edges: {
            color: '#e0d8b0',
            arrows: {
                to: true
            },
            smooth: true
        },
        physics: {
            enabled: true,
            stabilization: {
                enabled: true,
                iterations: 100
            },
            barnesHut: {
                gravitationalConstant: -2000,
                centralGravity: 0.3,
                springLength: 200
            }
        }
    };

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏
    const network = new vis.Network(container, data, options);

    function saveGraph() {
        const campaignTitle = "{{ campaign.title }}";
        const graphData = {
            nodes: nodes.get(),
            edges: edges.get()
        };

        fetch(`/api/campaigns/${campaignTitle}/graph`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(graphData)
        })
        .then(res => res.json())
        .then(json => {
            alert("–ì—Ä–∞—Ñ —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ");
        });
    }
</script>
{% endblock %}